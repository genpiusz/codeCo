<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baza Produkt贸w EAN</title>
    
    <!-- ADOWANIE BIBLIOTEKI QUAGGAJS DLA SKANOWANIA KODW KRESKOWYCH -->
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <style>
        :root {
            --kolor-glowny: #007bff;
            --kolor-tla: #f4f4f9;
            --kolor-bialy: #ffffff;
            --kolor-tekstu: #333;
            --kolor-cien: rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--kolor-tla);
            color: var(--kolor-tekstu);
        }
        .kontener {
            max-width: 600px;
            margin: 0 auto;
            background: var(--kolor-bialy);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--kolor-cien);
        }
        h1 {
            text-align: center;
            color: var(--kolor-glowny);
            margin-top: 0;
        }
        
        /* Sekcja formularza */
        .form-grupa {
            margin-bottom: 1rem;
        }
        .form-grupa label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-grupa input,
        .form-grupa select {
            width: 100%;
            padding: 0.75rem;
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* Grupowanie p贸l (np. cena) */
        .flex-grupa {
            display: flex;
            gap: 1rem;
        }
        .flex-grupa > .form-grupa {
            flex: 1; 
        }
        
        /* Sekcja EAN ze miejscem na skaner (PRZYCISK JEST WIDOCZNY!) */
        .ean-grupa {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .ean-grupa > .form-grupa {
            flex-grow: 1; 
        }
        /* PRZYCISK APARATU - TERAZ JEST WIDOCZNY */
        #przycisk-skanuj-aparat {
            display: block; /* Zmienione na block/widoczne */
            padding: 0.75rem 1rem;
            background-color: #28a745; /* Zielony kolor dla akcji kamery */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Przyciski */
        .przyciski-formularza {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .przycisk {
            padding: 0.85rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .przycisk-glowny {
            background-color: var(--kolor-glowny);
            color: white;
        }
        .przycisk-glowny:hover { background-color: #0056b3; }
        
        .przycisk-usun {
            background-color: #dc3545;
            color: white;
        }
        .przycisk-usun:hover { background-color: #c82333; }

        .przycisk-szukaj {
            background-color: #ffc107;
            color: #333;
        }
        .przycisk-szukaj:hover { background-color: #e0a800; }

        hr {
            border: 0;
            height: 1px;
            background: #ddd;
            margin: 2rem 0;
        }

        /* Sekcja Import/Eksport */
        .sekcja-io {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Lista produkt贸w */
        #lista-produktow {
            margin-top: 1.5rem;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }
        .produkt-karta {
            padding: 1rem;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .produkt-karta:hover {
            background-color: #f0f0f0;
        }
        .produkt-karta strong {
            color: var(--kolor-glowny);
        }

        /* Drobne komunikaty */
        #komunikat {
            text-align: center;
            padding: 0.5rem;
            margin-top: 1rem;
            border-radius: 4px;
            display: none; 
        }
        #komunikat.sukces {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        #komunikat.blad {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        /* STYLA DLA SKANERA KAMERY */
        #skaner-kontener {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
            display: none; /* Domylnie ukryty */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #skaner-kontener.aktywny {
            display: flex;
        }

        #wynik-skanowania {
            color: white;
            font-size: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        #przycisk-zamknij-skaner {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Konfiguracja dla QuaggaJS */
        #interactive.viewport {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Wymagane, aby QuaggaJS wywietla wideo i kadr */
        #interactive.viewport > canvas, #interactive.viewport > video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }

    </style>
</head>
<body>

    <main class="kontener">
        <h1>Baza Produkt贸w EAN</h1>

        <form id="formularz-produktu" onsubmit="return false;">

            <!-- SEKCJA EAN -->
            <label for="ean">EAN</label>
            <div class="ean-grupa">
                <div class="form-grupa" style="margin-bottom: 0;">
                    <input type="text" id="ean" name="ean" placeholder="Wpisz lub zeskanuj kod EAN..." required>
                </div>
                <!-- Przycisk do uruchamiania kamery -->
                <button type="button" id="przycisk-skanuj-aparat"> Skanuj</button>
            </div>
            
            <button type="button" id="przycisk-szukaj" class="przycisk przycisk-szukaj" style="width: 100%; margin-top: 0.5rem;">
                Wyszukaj / Wyczy
            </button>

            <hr>

            <!-- DANE PRODUKTU -->
            <div class="form-grupa">
                <label for="nazwa">Nazwa produktu</label>
                <input type="text" id="nazwa" name="nazwa" placeholder="Mleko UHT 3,2%">
            </div>

            <div class="flex-grupa">
                <div class="form-grupa">
                    <label for="sklep">Sklep</label>
                    <input type="text" id="sklep" name="sklep" placeholder="Biedronka">
                </div>
                <div class="form-grupa">
                    <label for="marka">Marka</label>
                    <input type="text" id="marka" name="marka" placeholder="Mleczna Dolina">
                </div>
            </div>

            <div class="flex-grupa">
                <div class="form-grupa">
                    <label for="producent">Producent</label>
                    <input type="text" id="producent" name="producent" placeholder="Mlekowita">
                </div>
                <div class="form-grupa">
                    <label for="pogrupowanie">Pogrupowanie</label>
                    <input type="text" id="pogrupowanie" name="pogrupowanie" placeholder="Mleko UHT">
                </div>
            </div>

            <div class="flex-grupa">
                <div class="form-grupa">
                    <label for="gramatura">Gramatura</label>
                    <input type="number" id="gramatura" name="gramatura" placeholder="500" step="any">
                </div>
                <div class="form-grupa">
                    <label for="rodzajGramatury">Rodzaj</label>
                    <select id="rodzajGramatury" name="rodzajGramatury">
                        <option value="ml">ml</option>
                        <option value="g">g</option>
                        <option value="szt">szt.</option>
                        <option value="kg">kg</option>
                        <option value="l">l</option>
                    </select>
                </div>
            </div>

            <div class="flex-grupa">
                <div class="form-grupa">
                    <label for="cena">Cena (z)</label>
                    <input type="number" id="cena" name="cena" placeholder="1.99" step="0.01">
                </div>
                <div class="form-grupa">
                    <label for="cenaPromo">Cena promo (z)</label>
                    <input type="number" id="cenaPromo" name="cenaPromo" placeholder="1.49" step="0.01">
                </div>
            </div>

            <div class="form-grupa">
                <label for="powiazane">Produkty powizane (EANy)</label>
                <input type="text" id="powiazane" name="powiazane" placeholder="Wpisz EANy po przecinku...">
            </div>
            
            <!-- Pole do przechowywania daty aktualizacji, ukryte -->
            <input type="hidden" id="dataAktualizacji" name="dataAktualizacji">
            
            <!-- Miejsce na komunikaty -->
            <div id="komunikat"></div>

            <!-- PRZYCISKI ZAPISU -->
            <div class="przyciski-formularza">
                <button type="button" id="przycisk-zapisz" class="przycisk przycisk-glowny">Zapisz zmiany</button>
                <button type="button" id="przycisk-usun" class="przycisk przycisk-usun">Usu produkt</button>
            </div>

        </form>

        <hr>

        <!-- SEKCJA IMPORT/EKSPORT -->
        <div class="sekcja-io">
            <button type="button" id="przycisk-eksport" class="przycisk" style="flex: 1;">Eksportuj do CSV</button>
            <input type="file" id="input-import" accept=".csv" style="display: none;">
            <button type="button" id="przycisk-import" class="przycisk" style="flex: 1;">Importuj z CSV</button>
        </div>

        <!-- LISTA PRODUKTW W BAZIE -->
        <h2>Zapisane produkty</h2>
        <div id="lista-produktow">
            <!-- Tutaj JavaScript bdzie dynamicznie wstawia produkty z bazy -->
        </div>

    </main>

    <!-- KONTENER SKANERA (penoekranowy) -->
    <div id="skaner-kontener">
        <!-- Przycisk do zamknicia okna skanowania -->
        <button id="przycisk-zamknij-skaner">X Zamknij</button>
        
        <!-- Miejsce na wywietlanie strumienia wideo z kamery -->
        <div id="interactive" class="viewport"></div>
        
        <!-- Tutaj bdzie wywietlany odczytany EAN -->
        <div id="wynik-skanowania">Gotowy do skanowania...</div>
    </div>


    <!-- 
      FAZA 5: DODANIE LOGIKI SKANERA KAMERY
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- STAE ELEMENTY UI ---
            const formularz = document.getElementById('formularz-produktu');
            const eanInput = document.getElementById('ean');
            const listaProduktowDiv = document.getElementById('lista-produktow');
            const komunikatDiv = document.getElementById('komunikat');
            
            // Przyciski i Kontenery
            const btnSzukaj = document.getElementById('przycisk-szukaj');
            const btnZapisz = document.getElementById('przycisk-zapisz');
            const btnUsun = document.getElementById('przycisk-usun');
            const btnEksport = document.getElementById('przycisk-eksport');
            const btnImport = document.getElementById('przycisk-import');
            const inputImport = document.getElementById('input-import');
            
            const btnSkanujAparat = document.getElementById('przycisk-skanuj-aparat');
            const skanerKontener = document.getElementById('skaner-kontener');
            const btnZamknijSkaner = document.getElementById('przycisk-zamknij-skaner');
            const wynikSkanowaniaDiv = document.getElementById('wynik-skanowania');

            
            // --- GWNA BAZA DANYCH ---
            let bazaProduktow = [];
            const KLUCZ_BAZY = 'mojaBazaProduktowEAN';
            const KOLUMNY_CSV = [
                'ean', 'nazwa', 'sklep', 'marka', 'producent', 'pogrupowanie', 
                'gramatura', 'rodzajGramatury', 'cena', 'cenaPromo', 'powiazane', 
                'dataAktualizacji'
            ];

            // --- FUNKCJE BAZY DANYCH (localStorage) ---

            const zaladujBaze = () => {
                const daneZLocalStorage = localStorage.getItem(KLUCZ_BAZY);
                if (daneZLocalStorage) {
                    try {
                        bazaProduktow = JSON.parse(daneZLocalStorage);
                    } catch (e) {
                        console.error("Bd adowania JSON z localStorage:", e);
                        bazaProduktow = [];
                    }
                } else {
                    bazaProduktow = [];
                }
                wyswietlListe();
            };

            const zapiszBaze = () => {
                localStorage.setItem(KLUCZ_BAZY, JSON.stringify(bazaProduktow));
            };
            
            const pokazKomunikat = (wiadomosc, typ = 'sukces') => {
                komunikatDiv.textContent = wiadomosc;
                komunikatDiv.className = `komunikat ${typ}`;
                
                setTimeout(() => {
                    komunikatDiv.className = '';
                    komunikatDiv.textContent = '';
                }, 4000);
            };

            // --- FUNKCJE FORMULARZA (bez zmian) ---

            const wyczyscFormularz = () => {
                formularz.reset();
                eanInput.focus();
            };
            
            const wypelnijFormularz = (produkt) => {
                if (!produkt) return;
                for (const klucz in produkt) {
                    const pole = formularz.elements[klucz];
                    if (pole) {
                        pole.value = produkt[klucz];
                    }
                }
            };

            const pobierzDaneZFormularza = () => {
                const formData = new FormData(formularz);
                const produkt = {};
                for (const [klucz, wartosc] of formData.entries()) {
                    produkt[klucz] = wartosc;
                }
                produkt.dataAktualizacji = new Date().toISOString().split('T')[0];
                return produkt;
            };

            // --- LOGIKA PRZYCISKW (Zapis, Usu, Szukaj - bez zmian) ---

            const wyszukajLubWyczysc = () => {
                const ean = eanInput.value.trim();
                
                if (!ean) {
                    wyczyscFormularz();
                    return;
                }
                
                const znalezionyProdukt = bazaProduktow.find(p => p.ean === ean);
                
                if (znalezionyProdukt) {
                    wypelnijFormularz(znalezionyProdukt);
                    pokazKomunikat(`Zaadowano produkt: ${znalezionyProdukt.nazwa}`);
                } else {
                    const wpisanyEAN = eanInput.value;
                    wyczyscFormularz();
                    eanInput.value = wpisanyEAN;
                    pokazKomunikat('Nowy produkt. Wypenij dane.', 'info');
                }
            };

            const zapiszProdukt = () => {
                const ean = eanInput.value.trim();
                if (!ean) {
                    pokazKomunikat('EAN jest wymagany!', 'blad');
                    eanInput.focus();
                    return;
                }
                
                const daneProduktu = pobierzDaneZFormularza();
                const indeksProduktu = bazaProduktow.findIndex(p => p.ean === ean);
                
                if (indeksProduktu > -1) {
                    bazaProduktow[indeksProduktu] = daneProduktu;
                    pokazKomunikat('Produkt zaktualizowany!', 'sukces');
                } else {
                    bazaProduktow.push(daneProduktu);
                    pokazKomunikat('Produkt dodany do bazy!', 'sukces');
                }
                
                zapiszBaze();
                wyswietlListe();
            };

            const usunProdukt = () => {
                const ean = eanInput.value.trim();
                if (!ean) {
                    pokazKomunikat('Wpisz EAN produktu do usunicia', 'blad');
                    return;
                }
                
                const indeksProduktu = bazaProduktow.findIndex(p => p.ean === ean);
                
                if (indeksProduktu > -1) {
                    bazaProduktow.splice(indeksProduktu, 1);
                    zapiszBaze();
                    wyswietlListe();
                    wyczyscFormularz();
                    pokazKomunikat('Produkt zosta usunity.', 'sukces');
                } else {
                    pokazKomunikat('Nie znaleziono produktu o tym EAN.', 'blad');
                }
            };

            // --- WYWIETLANIE LISTY (bez zmian) ---
            
            const wyswietlListe = () => {
                listaProduktowDiv.innerHTML = '';
                
                if (bazaProduktow.length === 0) {
                    listaProduktowDiv.innerHTML = '<p style="text-align: center; color: #777;">Brak produkt贸w w bazie. Dodaj pierwszy.</p>';
                    return;
                }
                
                bazaProduktow.forEach(produkt => {
                    const karta = document.createElement('div');
                    karta.className = 'produkt-karta';
                    karta.innerHTML = `
                        <strong>${produkt.nazwa || 'Brak nazwy'}</strong><br>
                        EAN: ${produkt.ean} | Akt.: ${produkt.dataAktualizacji || 'Brak daty'}
                    `;
                    
                    karta.addEventListener('click', () => {
                        wypelnijFormularz(produkt);
                        window.scrollTo(0, 0);
                    });
                    
                    listaProduktowDiv.appendChild(karta);
                });
            };

            // --- EKSPORT CSV (bez zmian) ---

            const eksportujCSV = () => {
                if (bazaProduktow.length === 0) {
                    pokazKomunikat('Baza jest pusta. Brak danych do eksportu.', 'blad');
                    return;
                }
                
                const naglowki = KOLUMNY_CSV.join(',');
                const wiersze = bazaProduktow.map(produkt => {
                    return KOLUMNY_CSV.map(klucz => {
                        let wartosc = produkt[klucz] || '';
                        if (typeof wartosc === 'string' && (wartosc.includes(',') || wartosc.includes('"') || wartosc.includes('\n'))) {
                            wartosc = `"${wartosc.replace(/"/g, '""')}"`;
                        }
                        return wartosc;
                    }).join(',');
                }).join('\n');

                const finalnyCSV = `${naglowki}\n${wiersze}`;
                
                const blob = new Blob([finalnyCSV], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const data = new Date().toISOString().split('T')[0];
                a.setAttribute('href', url);
                a.setAttribute('download', `produkty_export_${data}.csv`);
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                pokazKomunikat('Pomylnie wyeksportowano do CSV.', 'sukces');
            };

            // --- IMPORT CSV (bez zmian) ---

            const importujCSV = () => {
                inputImport.click();
            };

            const obsluzImportPliku = (event) => {
                const plik = event.target.files[0];
                if (!plik) return;
                
                if (confirm('Czy na pewno chcesz importowa? Spowoduje to cakowite nadpisanie (utrat) WSZYSTKICH obecnych danych w bazie.')) {
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const tekstCSV = e.target.result;
                        try {
                            const nowaBaza = przetworzCSV(tekstCSV);
                            
                            bazaProduktow = nowaBaza;
                            zapiszBaze();
                            wyswietlListe();
                            pokazKomunikat(`Pomylnie zaimportowano ${nowaBaza.length} produkt贸w.`, 'sukces');
                            wyczyscFormularz();

                        } catch (error) {
                            pokazKomunikat(`Bd importu: ${error.message}`, 'blad');
                            console.error("Bd przetwarzania CSV:", error);
                        }
                    };
                    reader.readAsText(plik);
                }
                event.target.value = '';
            };

            const przetworzCSV = (csv) => {
                const linie = csv.split('\n').filter(line => line.trim() !== '');
                if (linie.length === 0) {
                    throw new Error('Plik CSV jest pusty.');
                }
                
                const naglowkiDoUzycia = KOLUMNY_CSV; 
                const nowaBaza = [];

                for (let i = 1; i < linie.length; i++) {
                    // Uproszczone dzielenie, kt贸re ignoruje przecinki w cudzysowach
                    const wartosci = linie[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                    
                    if (wartosci.length < naglowkiDoUzycia.length) continue; 
                    
                    const produkt = {};
                    for (let j = 0; j < naglowkiDoUzycia.length; j++) {
                        produkt[naglowkiDoUzycia[j]] = wartosci[j];
                    }
                    
                    if (produkt.ean) { 
                        nowaBaza.push(produkt);
                    }
                }
                
                if (nowaBaza.length === 0) {
                    throw new Error('Nie znaleziono poprawnych produkt贸w do zaimportowania.');
                }
                
                return nowaBaza;
            };

            // --- NOWE FUNKCJE FAZY 5: SKANER KAMERY ---

            const startSkaner = () => {
                skanerKontener.classList.add('aktywny');
                wynikSkanowaniaDiv.textContent = 'adowanie kamery...';

                // Konfiguracja QuaggaJS
                Quagga.init({
                    // Pr贸ba u偶ycia tylnej kamery, jeli dostpna
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#interactive'),
                        constraints: {
                            facingMode: "environment" 
                        }
                    },
                    decoder: {
                        // Ograniczenie do kod贸w EAN/UPC dla wydajnoci
                        readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"] 
                    }
                }, function (err) {
                    if (err) {
                        wynikSkanowaniaDiv.textContent = 'Bd dostpu do kamery: ' + err.name;
                        console.error(err);
                        return;
                    }
                    Quagga.start();
                    wynikSkanowaniaDiv.textContent = 'Skanuj kod EAN!';
                });

                // Nasuchiwanie na odczytanie kodu
                Quagga.onDetected(onDetected);
            };

            const stopSkaner = () => {
                if (Quagga) {
                    Quagga.stop();
                }
                skanerKontener.classList.remove('aktywny');
                wynikSkanowaniaDiv.textContent = 'Gotowy do skanowania...';
            };

            const onDetected = (result) => {
                const ean = result.codeResult.code;
                
                // Sprawdzamy, czy kod ma odpowiedni dugo EAN-13 lub EAN-8
                if (ean.length === 13 || ean.length === 8) {
                    stopSkaner(); // Zatrzymujemy kamer
                    
                    // Wklejamy wynik do pola EAN
                    eanInput.value = ean; 
                    
                    // Automatycznie szukamy produktu po skanowaniu
                    wyszukajLubWyczysc();
                    
                    pokazKomunikat(`Kod EAN zeskanowany: ${ean}`, 'sukces');
                    
                    // Przewijamy na g贸r do formularza
                    window.scrollTo(0, 0); 
                } else {
                    wynikSkanowaniaDiv.textContent = `Znaleziono: ${ean} (czekam na EAN-13...)`;
                }
            };


            // --- INICJALIZACJA ---
            
            // Podpicie funkcji do przycisk贸w
            btnSzukaj.addEventListener('click', wyszukajLubWyczysc);
            btnZapisz.addEventListener('click', zapiszProdukt);
            btnUsun.addEventListener('click', usunProdukt);
            btnEksport.addEventListener('click', eksportujCSV);
            btnImport.addEventListener('click', importujCSV);
            inputImport.addEventListener('change', obsluzImportPliku);
            
            // Podpicie funkcji Skanera Kamery
            btnSkanujAparat.addEventListener('click', startSkaner);
            btnZamknijSkaner.addEventListener('click', stopSkaner);
            
            // Wczytanie bazy z localStorage przy starcie
            zaladujBaze();

            // Ustawienie kursora w polu EAN
            eanInput.focus();
        });
    </script>
</body>
</html>