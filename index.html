<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeCo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè∑Ô∏è</text></svg>">

    
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap">

    <style>
        :root {
            --kolor-glowny: dodgerblue;
            --kolor-tla: black;
            --kolor-bialy: white;
            --kolor-tekstu: black;
            --kolor-skaner: darkorange;
            --kolor-usun: crimson;
            --kolor-zapisz: dodgerblue;
        }
        body {
            font-family: Lexend;
            margin: 0;
            padding: 0.2rem;
            background-color: var(--kolor-tla);
            color: var(--kolor-tekstu);
        }
        .kontener {
            font-family: Lexend;
            max-width: 360px;
            margin: 0 auto;
            background: var(--kolor-bialy);
            padding: 0.5rem;
            border-radius: 24px;
            box-shadow: 0px 6px 2px gray;
        }
        h1 {
            text-align: center;
            color: var(--kolor-glowny);
            margin-top: 0;
        }
        
        /* Sekcja formularza */
        .form-grupa {
            margin-bottom: 0.2rem;
        }
        .form-grupa label {
            display: block;
            margin-bottom: 0.2rem;
            font-weight: 600;
        }
        .form-grupa input,
        .form-grupa select,
        .form-grupa textarea {
            font-family: Lexend;
            height: 48px;
            width: 100%;
            padding: 0.5rem;
            box-sizing: border-box; 
            border: 4px solid gray;
            border-radius: 24px;
            font-size: 0.9rem;
        }
        
        #warianty {
            padding: 0.3rem;
            font-size: 0.8rem;
            min-height: 48px;
            resize: none; /* u≈ºytkownik nie mo≈ºe rƒôcznie zmieniaƒá rozmiaru */
            overflow: hidden;
        }
        .form-grupa-nazwa {
            font-size: 1.2rem;
        }
        
        .flex-grupa {
            display: flex;
            gap: 0.2rem;
            align-items: flex-end; 
        }
        .flex-grupa > .form-grupa {
            flex: 1; 
        }

        /* --- MODYFIKACJA 2: Kontener na Datƒô i Gramaturƒô --- */
        .meta-info-kontener {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Zawijanie na mniejszych ekranach */
            gap: 0.5rem 0.2rem; /* Mniejszy odstƒôp pionowy, wiƒôkszy poziomy */
            margin: 0 0 1rem 0;
            font-size: 0.9em;
            color: var(--kolor-glowny); /* Kolor bazowy dla obu */
        }
        /* Styl dla gramatury (zmieniony) */
        #gramatura-display-kontener {
            font-weight: bold; /* Zgodnie z pro≈õbƒÖ */
            color: var(--kolor-glowny); /* Upewnienie siƒô, ≈ºe ma ten sam kolor */
            
        }


        /* --- MODYFIKACJA 1: NOWY UK≈ÅAD CENY (3 R√ìWNE KOLUMNY) --- */
        .cena-sekcja-glowna {
            display: flex;
            justify-content: space-between;
            align-items: center;
            display: flex;
            margin-bottom: 0.2rem;
        }

        /* Wsp√≥lny styl dla 3 kolumn */
        .kolumna-przycisk-skan {
            margin-left: 16px;
        }
        
        /* Kolumna 1: Cena Regularna + Przelicznik */
        .kolumna-cena-reg #cena {
            height: 68px; /* Wysoko≈õƒá zgodna z przyciskiem */
            font-size: 2.5rem; /* Du≈ºa czcionka */
            text-align: center;
            font-style: italic;
            border: 6px solid darkorange;
            border-radius: 40px;
            font-weight: 700;
            color: black;
            padding: 0;
            width: 100%; /* Wype≈Çnij kolumnƒô */
            
        }
        
        #cena::-webkit-inner-spin-button,
        #cena::-webkit-outer-spin-button {
            -webkit-appearance: none; /* Chrome, Safari, Edge */
            margin: 0;
        }
        .cena-jednostkowa-info {
            text-align: center;
            font-size: 1rem;
            color: black;
            margin-top: 0.2rem;
            line-height: 1.2;
        }

        /* Kolumna 2: Cena Promo (MA≈ÅA) */
        .kolumna-cena-promo {
            gap: 0.2rem;
        }
        #cenaPromo {
            /* Domy≈õlna wysoko≈õƒá (na podstawie paddingu) */
            font-style: italic;
            height: 48px;
            padding: 0.75rem;
            box-sizing: border-box; 
            border: 4px solid darkorange;
            border-radius: 24px;
            background-color: darkorange;
            font-weight: 700; /* Bold */
            color: black;
            text-align: center;
            width: 100%;
            font-size: 1.2rem;
            
        }
        
        #cenaPromo::-webkit-inner-spin-button,
        #cenaPromo::-webkit-outer-spin-button {
            -webkit-appearance: none; /* Chrome, Safari, Edge */
            margin: 0;
        }
        
        #iloscZestaw {
            /* Domy≈õlna wysoko≈õƒá (na podstawie paddingu) */
            font-style: italic;
            height: 48px;
            padding: 0.75rem;
            box-sizing: border-box; 
            border: 4px solid darkorange;
            border-radius: 24px;
            background-color: darkorange;
            font-weight: 700; /* Bold */
            color: black;
            text-align: center;
            width: 80px;
            font-size: 1.2rem;
        }
        
        #iloscZestaw::-webkit-inner-spin-button,
        #iloscZestaw::-webkit-outer-spin-button {
            -webkit-appearance: none; /* Chrome, Safari, Edge */
            margin: 0;
        }
        
        input::placeholder{
            color: dimgray;
            font-style: italic;
            font-weight: thin;
        }
        
        #cenaPromo::placeholder{
            color: dimgray;
            font-style: italic;
            font-weight: normal;
        }
        #iloscZestaw::placeholder{
            color: dimgray;
            font-style: italic;
            font-weight: normal;
        }
        
        /* Kolumna 3: Przycisk Skanowania */
        .kolumna-przycisk-skan {
             justify-content: center; /* Wy≈õrodkuj przycisk w kolumnie */
             align-items: center; /* Wy≈õrodkuj w poziomie */
             height: 80px; /* Ustaw wysoko≈õƒá kolumny, aby wyr√≥wnaƒá */
        }
        #przycisk-skanuj-zapisz {
            width: 80px; 
            height: 80px; 
            border-radius: 40px; 
            border: none;
            background-color: var(--kolor-skaner);
            color: white;
            font-size: 2.5rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            flex-shrink: 0;
        }
        #przycisk-skanuj-zapisz:active {
            background-color: tomato;
            box-shadow: 0px 4px dimgray inset;
        }
        

        /* Sekcja EAN ze miejscem na skaner */
        .ean-grupa {
            display: flex;
            gap: 0.2rem;
            align-items: flex-end;
        }
        .ean-grupa > .form-grupa {
            flex-grow: 1; 
        }
        
        #przycisk-skanuj-powiazany {
            height: 48px;
            width: 80px;
            padding: 0; 
            border: none;
            border-radius: 24px; 
            cursor: pointer;
            font-size: 1.2rem; 
            line-height: 1;
            background-color: var(--kolor-skaner); 
            color: white;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
        }
        #przycisk-skanuj-powiazany:active {
            background-color: tomato;
            box-shadow: 0px 4px dimgray inset;
        }

        hr {
            border: 0;
            height: 1px;
            background: gray;
        }

        .sekcja-io {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.2rem; 
            margin-bottom: 1.5rem;
            
            display: flex;
            justify-content: space-between;
            align-items: center;
            display: flex;
            margin-bottom: 0.5rem;
        }
        .przycisk {
            font: Lexend;
            height: 48px;
            width: 100%;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
            display: flex; 
            align-items: center;
            justify-content: center;
            
        }
        .przycisk i {
            margin-right: 0;
            font-size: 1.1rem;
        }

        .przycisk-io {
            font: Lexend;
            background-color: gainsboro;
            color: var(--kolor-tekstu);
        }
        .przycisk-io:active { background-color: gray; box-shadow: 0px 4px dimgray inset; }
        
        .przycisk-zapisz {
            background-color: var(--kolor-zapisz);
            color: white;
        }
        .przycisk-zapisz:active { background-color: royalblue; box-shadow: 0px 4px dimgray inset; }

        .przycisk-usun {
            background-color: var(--kolor-usun);
            color: white;
        }
        .przycisk-usun:active { background-color: darkred; box-shadow: 0px 4px dimgray inset;}

        #lista-produktow {
            margin-top: 1.5rem;
            border-top: 1px solid gray;
            padding-top: 1rem;
        }
        .produkt-karta {
            padding: 1rem;
            background: white;
            border: 2px solid gray;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .produkt-karta:active {
            background-color: gainsboro;
            box-shadow: 0px 4px royalblue inset;
        }
        
        .produkt-karta-naglowek {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        .produkt-nazwa {
            color: dodgerblue;
            font-weight: bold;
            flex-grow: 1;
            margin-right: 8px;
        }
        .cena-reg-kontener {
            border: 3px solid darkorange;
            color: black;
            padding: 2px 5px;
            font-weight: bold;
            border-radius: 3px;
            margin-left: 8px;
            font-size: 1.1em;
            flex-shrink: 0;
            text-align: right;
        }
        .cena-promo-kontener {
            background-color: darkorange;
            color: black;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 8px;
            font-size: 1em;
            flex-shrink: 0;
        }
        .produkt-detale {
            font-size: 0.9em;
            color: black;
            display: flex;
            margin-bottom: 2px;
            justify-content: space-between;
        }
        .produkt-metadata {
            font-size: 0.8em;
            color: slategray;
            display: flex;
            justify-content: space-between;
        }
        
        #skaner-kontener {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 1000;
            padding: 10px;
            box-sizing: border-box;
        }
        #skaner-kontener.aktywny {
            display: flex;
        }

        #przycisk-zamknij-skaner {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--kolor-usun);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1001;
        }

        #interactive.viewport {
            width: 95%;
            max-width: 550px;
            height: 70vh;
            position: relative;
            border: 3px solid var(--kolor-skaner);
            margin-top: 50px;
        }
        #interactive.viewport canvas, #interactive.viewport video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #wynik-skanowania {
            color: white;
            font-size: 1.2rem;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <main class="kontener">
        <form id="formularz-produktu" onsubmit="return false;">

            <div class="ean-grupa">
                <div class="form-grupa" style="margin-bottom: 0;">
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="ean" name="ean" placeholder="Wpisz lub zeskanuj kod EAN..." style="border: 4px solid black;" required>
                </div>
            </div>
            
            <div class="flex-grupa">
                <div class="form-grupa">
                    <label for="marka"></label>
                    <input type="text" id="marka" name="marka" placeholder="MARKA">
                </div>
                <div class="form-grupa">
                    <label for="sklep"></label>
                    <select id="sklep" name="sklep">
                        <option value="BIED">BIED</option>
                        <option value="LIDL">LIDL</option>
                        <option value="DINO">DINO</option>
                        <option value="KAUF">KAUF</option>
                        <option value="AUCH">AUCH</option>
                        <option value="ELEC">ELEC</option>
                        <option value="ACTI">ACTI</option>
                        <option value="ROSS">ROSS</option>
                        <option value="PEPC">PEPC</option>
                        <option value="INNE">INNE</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grupa" style="margin-bottom: 0.5rem;">
                <label for="nazwa"></label>
                <input type="text" id="nazwa" name="nazwa" placeholder="Nazwa 1szt." style="color: dodgerblue; font-weight: bold; border: 4px solid dodgerblue;">
            </div>
            
            <!-- MODYFIKACJA 2: Gramatura i Data Aktualizacji (Jeden wiersz) -->
            <div class="meta-info-kontener">
                <div id="gramatura-display-kontener">
                    <strong id="gramaturaText"></strong> /
                    <class="cena-jednostkowa-info" id="cenaJednostkowaDisplay"></class>
                </div>
                <div id="data-aktualizacji-kontener">
                    <strong id="dataAktualizacjiDisplay">Brak</strong>
                </div>
            </div>
            <!-- Ukryte pola przechowujƒÖce warto≈õci dla logiki aplikacji -->
            <input type="hidden" id="gramatura" name="gramatura" value="1">
            <input type="hidden" id="rodzajGramatury" name="rodzajGramatury" value="szt">
            <input type="hidden" id="dataAktualizacji" name="dataAktualizacji">

            <!--  -->
            <div class="cena-sekcja-glowna">
                
                <!-- Kolumna 1: Cena Regularna + Przelicznik -->
                <div class="kolumna-cena-reg">
                    <input type="number" id="cena" name="cena" placeholder="0.00" step="0.01">
                </div>

                <!-- Kolumna 3: Przycisk Skanowania -->
                <div class="kolumna-przycisk-skan">
                    <button type="button" id="przycisk-skanuj-zapisz" title="Zapisz zmiany i zeskanuj nowy EAN">
                        <i class="fas fa-barcode"></i>
                    </button>
                </div>
            </div>
            <div class="flex-grupa">

                
                <!-- Kolumna 2: Cena Promo (MA≈ÅA) -->
                <div>
                    <input type="number" id="cenaPromo" name="cenaPromo" placeholder="0,00" step="0.01">
                </div>przy <br> zak.
                <div>
                    <input type="number" id="iloscZestaw" name="iloscZestaw" placeholder="1 szt." value="1">
                </div>
            </div>
            
            <div class="flex-grupa">
                <div class="form-grupa">
                    <label for="producent"></label>
                    <input type="text" id="producent" name="producent" placeholder="Producent">
                </div>
                <div class="form-grupa">
                    <label for="pogrupowanie"></label>
                    <select id="pogrupowanie" name="pogrupowanie">
                        <option value="S≈ÅONY">S≈ÅONY</option>
                        <option value="S≈ÅODKI">S≈ÅODKI</option>
                        <option value="NAPOJE">NAPOJE</option>
                        <option value="DPH">DPH</option>
                        <option value="GOSPO">GOSPO.</option>
                        <option value="Worki na ≈õmieci">Worki na ≈õmieci</option>
                        <option value="MAJSTER">MAJSTER.</option>
                        <option value="SEZON">SEZON</option>
                        <option value="≈öWIE≈ªY">≈öWIE≈ªY</option>
                        <option value="Jogurty">Jogurty</option>
                        <option value="Sery">Sery</option>
                    </select>
                </div>
            </div>

            <div class="form-grupa">
                <label for="powiazane">Produkty powiƒÖzane (EANy)</label>
                <div class="ean-grupa" style="align-items: flex-end;">
                    <input type="text" id="powiazane" name="powiazane" placeholder="Wpisz EANy po przecinku...">
                    <button type="button" id="przycisk-skanuj-powiazany" title="Skanuj powiƒÖzany EAN" class="przycisk">
                        <i class="fas fa-barcode"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-grupa">
                <label for="warianty">Warianty (np. smaki, kolory)</label>
                <textarea id="warianty" name="warianty" placeholder="np. Czekoladowy, Waniliowy, Czerwony"
                          oninput="this.style.height='auto'; this.style.height=this.scrollHeight + 'px';"></textarea>
            </div>
            
            <!-- POLE OPIS JEST USUNIƒòTE Z LOGIKI, ALE ZOSTAWIONE W HTML DLA ZACHOWANIA UK≈ÅADU (ZGODNIE Z PRO≈öBƒÑ) -->
            <textarea id="opis" name="opis" style="display:none;"></textarea>

            <div id="komunikat"></div>

        </form>

        <div class="sekcja-io">
            <button type="button" id="przycisk-dodaj" class="przycisk przycisk-zapisz" title="Dodaj lub nadpisz produkt (EAN + Sklep)">
                <i class="fas fa-plus"></i> 
            </button>
            <button type="button" id="przycisk-zapisz" class="przycisk przycisk-zapisz" title="Zapisz dane wsp√≥lne (Nazwa, Marka itp.) dla WSZYSTKICH produkt√≥w z tym EAN">
                <i class="fas fa-save"></i> 
            </button>
            <button type="button" id="przycisk-eksport" class="przycisk przycisk-io" title="Eksportuj ca≈ÇƒÖ bazƒô do pliku CSV">
                <i class="fas fa-file-export"></i>
            </button>
            <input type="file" id="input-import" accept=".csv" style="display: none;">
            <button type="button" id="przycisk-import" class="przycisk przycisk-io" title="Importuj bazƒô z pliku CSV (nadpisz lub po≈ÇƒÖcz)">
                <i class="fas fa-file-import"></i>
            </button>
            <button type="button" id="przycisk-usun" class="przycisk przycisk-usun" title="Usu≈Ñ obecny produkt z bazy (EAN + Sklep)">
                <i class="fas fa-xmark"></i> 
            </button>
          </div>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem;">
            <button type="button" id="przycisk-filtr" class="przycisk przycisk-zapisz" style="width: 48px;" title="Filtruj listƒô: Wszystko">
                <i class="fas fa-filter"></i> 
            </button>
            <h2>Zapisane produkty</h2> 
      			<button type="button" id="przycisk-wyczysc-baze" class="przycisk przycisk-usun" style="width: 48px;" title="Usu≈Ñ CA≈ÅƒÑ bazƒô produkt√≥w (czyszczenie localStorage)">
      			    <i class="fas fa-trash-alt"></i>
      			</button>
        </div>
        
        <div id="lista-produktow">
        </div>

    </main>

    <div id="skaner-kontener">
        <button id="przycisk-zamknij-skaner">X Zamknij</button>
        <div id="interactive" class="viewport"></div>
        <div id="wynik-skanowania">Gotowy do skanowania...</div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- STA≈ÅE ELEMENTY UI ---
            const formularz = document.getElementById('formularz-produktu');
            const eanInput = document.getElementById('ean');
            const listaProduktowDiv = document.getElementById('lista-produktow');
            const komunikatDiv = document.getElementById('komunikat');
            
            // ZMODYFIKOWANE: btnZapisz to teraz przycisk do aktualizacji danych wsp√≥lnych
            const btnDodaj = document.getElementById('przycisk-dodaj'); // NOWY
            const btnZapiszWspolne = document.getElementById('przycisk-zapisz'); // ZMIANA ZNACZENIA
            const btnUsun = document.getElementById('przycisk-usun'); 
            const btnEksport = document.getElementById('przycisk-eksport');
            const btnImport = document.getElementById('przycisk-import');
            const inputImport = document.getElementById('input-import');
            const btnWyczyscBaze = document.getElementById('przycisk-wyczysc-baze'); 
            
            // ZMODYFIKOWANE: Logika dla przycisku filtra
            const btnFiltr = document.getElementById('przycisk-filtr'); 

            const btnSkanujZapisz = document.getElementById('przycisk-skanuj-zapisz'); 
            const skanerKontener = document.getElementById('skaner-kontener');
            const btnZamknijSkaner = document.getElementById('przycisk-zamknij-skaner');
            const wynikSkanowaniaDiv = document.getElementById('wynik-skanowania');
            
            // Pole 'opis' nie jest ju≈º u≈ºywane w logice CSV, ale zostaje dla sp√≥jno≈õci formularza
            const opisInput = document.getElementById('opis'); 
            
            const nazwaInput = document.getElementById('nazwa');
            const dataAktualizacjiDisplay = document.getElementById('dataAktualizacjiDisplay'); 
            const dataAktualizacjiInput = document.getElementById('dataAktualizacji'); 
            const btnSkanujPowiazany = document.getElementById('przycisk-skanuj-powiazany');
            
            const cenaInput = document.getElementById('cena');
            const cenaPromoInput = document.getElementById('cenaPromo');
            const iloscZestawInput = document.getElementById('iloscZestaw'); 

            // NOWE ELEMENTY UI (Gramatura i Cena Jednostkowa)
            const gramaturaInput = document.getElementById('gramatura');
            const rodzajGramaturyInput = document.getElementById('rodzajGramatury');
            const gramaturaText = document.getElementById('gramaturaText');
            const cenaJednostkowaDisplay = document.getElementById('cenaJednostkowaDisplay');

            // --- STAN SKANERA ---
            let ostatnioZeskanowanyEAN = null;
            let licznikPoprawnychOdczytow = 0;
            const WYMAGANY_COUNT = 3; 
            let skanerAktywny = 'glowny'; 
            
            // ZMODYFIKOWANE: Stan filtra (zamiast filtrPogrupowanieAktywny)
            let stanFiltru = 'wszystko'; // 'wszystko', 'ean', 'nazwa', 'grupa'

            // --- G≈Å√ìWNA BAZA DANYCH ---
            let bazaProduktow = [];
            const KLUCZ_BAZY = 'mojaBazaProduktowEAN';
            
            let ostatniUzytySklep = 'BIED'; 
            let ostatnieUzytePogrupowanie = '';
            
            // ZMODYFIKOWANE: Usuniƒôto 'opis' z listy kolumn (Zadanie 5)
            const KOLUMNY_CSV = [
                'ean', 'nazwa', /* 'opis' usuniƒôty */ 'sklep', 'marka', 'producent', 'pogrupowanie', 
                'gramatura', 'rodzajGramatury', 'cena', 'cenaPromo', 'iloscZestaw', 
                'dataAktualizacji', 'warianty', 'powiazane'
            ];

            // --- NARZƒòDZIA DATY DLA IMPORTU ---
            const parseDate = (dateStr) => {
                if (!dateStr || dateStr.toLowerCase() === 'brak daty') return new Date(0); 
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                }
                return new Date(0);
            };
            
            const zaladujBaze = () => {
                const daneZLocalStorage = localStorage.getItem(KLUCZ_BAZY);
                if (daneZLocalStorage) {
                    try {
                        bazaProduktow = JSON.parse(daneZLocalStorage);
                    } catch (e) {
                        console.error("B≈ÇƒÖd ≈Çadowania JSON z localStorage:", e);
                        bazaProduktow = [];
                    }
                } else {
                    bazaProduktow = [];
                }
                wyswietlListe();
            };

            const zapiszBaze = () => {
                localStorage.setItem(KLUCZ_BAZY, JSON.stringify(bazaProduktow));
            };
            
            const pokazKomunikat = (wiadomosc, typ = 'sukces') => {
                komunikatDiv.textContent = wiadomosc;
                komunikatDiv.className = `komunikat ${typ}`;
                
                setTimeout(() => {
                    komunikatDiv.className = '';
                    komunikatDiv.textContent = '';
                }, 4000);
            };

            const wyczyscFormularz = () => {
                formularz.reset();
                dataAktualizacjiDisplay.textContent = 'Brak';
                dataAktualizacjiInput.value = '';
                iloscZestawInput.value = 1; 
                document.getElementById('sklep').value = ostatniUzytySklep;
                
                // Reset wizualny gramatury i ceny jednostkowej
                gramaturaText.textContent = "--";
                // Ustawienie domy≈õlnych warto≈õci w ukrytych polach
                gramaturaInput.value = 1;
                rodzajGramaturyInput.value = 'szt';
                
                cenaJednostkowaDisplay.textContent = "--";
            };
            
            const wypelnijFormularz = (produkt) => {
                if (!produkt) return;
                for (const klucz in produkt) {
                    const pole = formularz.elements[klucz];
                    if (pole && typeof produkt[klucz] !== 'undefined') { 
                        pole.value = produkt[klucz];
                    }
                }
                // opisInput.value = produkt.opis || ''; // 'opis' nie jest ju≈º kluczowy
                document.getElementById('warianty').value = produkt.warianty || '';
                
                iloscZestawInput.value = produkt.iloscZestaw || 1; 

                if (!produkt.sklep) {
                    document.getElementById('sklep').value = ostatniUzytySklep;
                }

                const data = produkt.dataAktualizacji || 'Brak';
                dataAktualizacjiDisplay.textContent = data;
                dataAktualizacjiInput.value = data !== 'Brak' ? data : '';
                
                // Upewnienie siƒô, ≈ºe gramatura ma warto≈õƒá (dla starych danych)
                const gram = produkt.gramatura || 1;
                const rodzaj = produkt.rodzajGramatury || 'szt';
                gramaturaInput.value = gram;
                rodzajGramaturyInput.value = rodzaj;
                
                // Aktualizacja wy≈õwietlania gramatury i ceny jednostkowej po za≈Çadowaniu
                zaktualizujWidokGramatury(gram, rodzaj);
                obliczCeneJednostkowa();

                wyswietlListe();
            };

            // Funkcja pomocnicza do aktualizacji widoku gramatury
            const zaktualizujWidokGramatury = (gram, rodzaj) => {
                if (gram && rodzaj) {
                    gramaturaText.textContent = `${gram} ${rodzaj}`;
                } else {
                    gramaturaText.textContent = "Brak danych";
                }
            };

            const pobierzDaneZFormularza = () => {
                const formData = new FormData(formularz);
                const produkt = {};
                for (const [klucz, wartosc] of formData.entries()) {
                    produkt[klucz] = wartosc;
                }
                // produkt.opis = opisInput.value; // 'opis' nie jest ju≈º kluczowy
                return produkt;
            };

            // ZMODYFIKOWANE: Logika wyszukiwania (Zadanie 3)
            const wyszukajLubWyczysc = () => {
                const ean = eanInput.value.trim();
                const wybranySklep = document.getElementById('sklep').value;
                
                if (!ean) {
                    wyczyscFormularz();
                    nazwaInput.focus();
                    wyswietlListe(); 
                    return;
                }
                
                // 1. Wyszukaj EAN + Sklep
                let znalezionyProdukt = bazaProduktow.find(p => p.ean === ean && p.sklep === wybranySklep);
                
                // 2. Je≈õli nie ma, wyszukaj sam EAN (w innym sklepie)
                if (!znalezionyProdukt) {
                    znalezionyProdukt = bazaProduktow.find(p => p.ean === ean);
                }
                
                // 3. Je≈õli nie ma, wyszukaj w powiƒÖzanych (z priorytetem sklepu)
                if (!znalezionyProdukt) {
                    let znalezionyPowiazany = bazaProduktow.find(p => {
                        if (!p.powiazane) return false;
                        const powiazaneEANy = p.powiazane.split(',').map(e => e.trim());
                        return powiazaneEANy.includes(ean) && p.sklep === wybranySklep;
                    });
                    
                    if (!znalezionyPowiazany) {
                         znalezionyPowiazany = bazaProduktow.find(p => {
                            if (!p.powiazane) return false;
                            const powiazaneEANy = p.powiazane.split(',').map(e => e.trim());
                            return powiazaneEANy.includes(ean);
                        });
                    }
                    znalezionyProdukt = znalezionyPowiazany; // Przypisz, je≈õli znaleziono
                }
                
                if (znalezionyProdukt) {
                    wypelnijFormularz(znalezionyProdukt);
                    
                    if (znalezionyProdukt.ean !== ean) {
                         pokazKomunikat(`Znaleziono EAN powiƒÖzany. Za≈Çadowano: ${znalezionyProdukt.nazwa}`, 'info');
                    } else if (znalezionyProdukt.sklep !== wybranySklep) {
                         pokazKomunikat(`Za≈Çadowano produkt ze sklepu: ${znalezionyProdukt.sklep}`, 'info');
                    } else {
                         pokazKomunikat(`Za≈Çadowano produkt: ${znalezionyProdukt.nazwa}`);
                    }
                    nazwaInput.focus(); 

                } else {
                    const wpisanyEAN = eanInput.value;
                    wyczyscFormularz();
                    eanInput.value = wpisanyEAN; 
                    
                    document.getElementById('sklep').value = ostatniUzytySklep;
                    document.getElementById('pogrupowanie').value = ostatnieUzytePogrupowanie;
                    
                    // Przy nowym produkcie, wywo≈Çaj auto-uzupe≈Çnianie, aby ustawiƒá domy≈õlne 1 szt.
                    autoUzupelnijGramature();
                    
                    pokazKomunikat('Nowy produkt (EAN nieznaleziony). Wype≈Çnij dane.', 'info');
                    nazwaInput.focus();
                }
            };

            // NOWA FUNKCJA: Logika dla przycisku "Dodaj" (Zadanie 1)
            const dodajProdukt = () => {
                const daneProduktu = pobierzDaneZFormularza();
                const ean = daneProduktu.ean.trim();
                
                if (!ean) {
                    pokazKomunikat('EAN jest wymagany!', 'blad');
                    eanInput.focus();
                    return false;
                }

                // Szukaj wg EAN + Sklep
                const indeksProduktu = bazaProduktow.findIndex(p => p.ean === ean && p.sklep === daneProduktu.sklep);
                const dzisiejszaData = new Date().toISOString().split('T')[0];

                if (indeksProduktu > -1) {
                    // --- NADPISANIE PRODUKTU (ten sam EAN, ten sam Sklep) ---
                    const staryProdukt = bazaProduktow[indeksProduktu];
                    
                    // Sprawd≈∫, czy cena siƒô zmieni≈Ça, aby zaktualizowaƒá datƒô
                    if (String(staryProdukt.cena) !== String(daneProduktu.cena) || 
                        String(staryProdukt.cenaPromo) !== String(daneProduktu.cenaPromo) ||
                        String(staryProdukt.iloscZestaw) !== String(daneProduktu.iloscZestaw)
                    ) {
                        daneProduktu.dataAktualizacji = dzisiejszaData;
                    } else {
                        // Zachowaj starƒÖ datƒô, je≈õli cena bez zmian
                        daneProduktu.dataAktualizacji = staryProdukt.dataAktualizacji || dzisiejszaData;
                    }
                    
                    bazaProduktow[indeksProduktu] = daneProduktu;
                    pokazKomunikat('Produkt nadpisany (ten sam EAN i Sklep)!', 'sukces');
                    
                } else {
                    // --- NOWY PRODUKT (inny sklep lub nowy EAN) ---
                    daneProduktu.dataAktualizacji = dzisiejszaData;
                    bazaProduktow.push(daneProduktu);
                    pokazKomunikat('Produkt dodany jako nowa pozycja (inny sklep lub nowy EAN)!', 'sukces');
                }

                // Zapisz ostatnie ustawienia
                ostatniUzytySklep = daneProduktu.sklep;
                ostatnieUzytePogrupowanie = daneProduktu.pogrupowanie;
                
                zapiszBaze();
                wyswietlListe(); // Od≈õwie≈º listƒô
                
                // Od≈õwie≈º widok daty, gramatury i ceny po zapisie
                dataAktualizacjiDisplay.textContent = daneProduktu.dataAktualizacji;
                dataAktualizacjiInput.value = daneProduktu.dataAktualizacji;
                zaktualizujWidokGramatury(daneProduktu.gramatura, daneProduktu.rodzajGramatury);
                obliczCeneJednostkowa();

                return true;
            };

            // ZMODYFIKOWANA FUNKCJA: Logika dla przycisku "Zapisz" (Zadanie 2)
            // Ta funkcja teraz aktualizuje dane wsp√≥lne dla WSZYSTKICH produkt√≥w z tym samym EAN
            const zapiszDaneWspolne = () => {
                const ean = eanInput.value.trim();
                if (!ean) {
                    pokazKomunikat('Wpisz EAN produkt√≥w do aktualizacji', 'blad');
                    eanInput.focus();
                    return;
                }

                const daneFormularza = pobierzDaneZFormularza();
                let zaktualizowanoLicznik = 0;

                bazaProduktow.forEach(produkt => {
                    if (produkt.ean === ean) {
                        produkt.nazwa = daneFormularza.nazwa;
                        produkt.marka = daneFormularza.marka;
                        produkt.producent = daneFormularza.producent;
                        produkt.pogrupowanie = daneFormularza.pogrupowanie;
                        produkt.powiazane = daneFormularza.powiazane;
                        produkt.warianty = daneFormularza.warianty;
                        // NIE aktualizujemy ceny, sklepu, daty itp. - tylko dane wsp√≥lne
                        zaktualizowanoLicznik++;
                    }
                });

                if (zaktualizowanoLicznik > 0) {
                    zapiszBaze();
                    wyswietlListe();
                    pokazKomunikat(`Zaktualizowano dane wsp√≥lne dla ${zaktualizowanoLicznik} produkt√≥w z tym EAN.`, 'sukces');
                } else {
                    pokazKomunikat('Nie znaleziono ≈ºadnych produkt√≥w z tym EAN do aktualizacji.', 'info');
                }
            };

            // ZMODYFIKOWANA FUNKCJA: Przycisk skanowania u≈ºywa teraz `dodajProdukt`
            const zapiszISkanujNowy = () => {
                const ean = eanInput.value.trim();
            
                if (!ean) {
                    // Je≈õli pole EAN jest puste, po prostu zacznij skanowaƒá
                    startSkaner('glowny');
                } else {
                    // Je≈õli jest EAN, spr√≥buj dodaƒá/nadpisaƒá produkt
                    // funkcja dodajProdukt() zwr√≥ci true je≈õli siƒô powiedzie
                    if (dodajProdukt()) {
                        // Je≈õli zapis siƒô powi√≥d≈Ç, uruchom skaner
                        startSkaner('glowny');
                    }
                    // Je≈õli zapis siƒô nie powi√≥d≈Ç (np. brak EAN), skaner siƒô nie uruchomi
                }
            };


            const usunProdukt = () => {
                const ean = eanInput.value.trim();
                const sklep = document.getElementById('sklep').value;
                
                if (!ean) {
                    pokazKomunikat('Wpisz EAN produktu do usuniƒôcia', 'blad');
                    return;
                }
                
                // Usu≈Ñ tylko konkretny produkt (EAN + Sklep)
                const indeksProduktu = bazaProduktow.findIndex(p => p.ean === ean && p.sklep === sklep);
                
                if (indeksProduktu > -1) {
                    if (window.confirm(`Czy na pewno usunƒÖƒá ${bazaProduktow[indeksProduktu].nazwa} (EAN: ${ean}) ze sklepu ${sklep}?`)) { 
                        bazaProduktow.splice(indeksProduktu, 1);
                        zapiszBaze();
                        wyswietlListe();
                        wyczyscFormularz();
                        pokazKomunikat('Produkt zosta≈Ç usuniƒôty.', 'sukces');
                    }
                } else {
                    pokazKomunikat(`Nie znaleziono produktu o EAN ${ean} w sklepie ${sklep}.`, 'blad');
                }
            };

            const wyczyscCalaBaze = () => {
                if (window.confirm("UWAGA! Czy na pewno chcesz usunƒÖƒá CA≈ÅƒÑ bazƒô produkt√≥w? Tego dzia≈Çania NIE MO≈ªNA COFNƒÑƒÜ!")) {
                    if (window.confirm("POTWIERD≈π USUNIƒòCIE: Naci≈õnij OK, aby trwale usunƒÖƒá WSZYSTKIE produkty.")) {
                        localStorage.removeItem(KLUCZ_BAZY);
                        bazaProduktow = [];
                        wyczyscFormularz();
                        wyswietlListe();
                        pokazKomunikat('Ca≈Ça baza danych zosta≈Ça usuniƒôta.', 'blad');
                    }
                }
            };
            
            // NOWA FUNKCJA: Helper do obliczania ceny jednostkowej dla kart (Zadanie 4)
            const obliczCeneJednostkowaDlaKarty = (produkt) => {
                const cena = parseFloat(produkt.cena);
                // U≈ºyj warto≈õci domy≈õlnych, je≈õli brakuje danych (dla starych wpis√≥w)
                const waga = parseFloat(produkt.gramatura) || 1;
                const jednostka = produkt.rodzajGramatury || 'szt';

                if (!cena || isNaN(cena) || isNaN(waga) || waga === 0) {
                    return "- /-"; // Nie mo≈ºna obliczyƒá
                }

                let wynik = 0;
                let jednostkaWynikowa = "";

                if (jednostka === 'g' || jednostka === 'ml') {
                    wynik = (cena / waga) * 100;
                    jednostkaWynikowa = (jednostka === 'g') ? '100g' : '100ml';
                } else if (jednostka === 'kg' || jednostka === 'l' || jednostka === 'm') {
                     wynik = cena / waga;
                     jednostkaWynikowa = jednostka;
                } else if (jednostka === 'szt' && waga > 1) {
                     wynik = cena / waga;
                     jednostkaWynikowa = 'szt';
                } else {
                    // Domy≈õlnie (dla 1 szt) nie pokazuj ceny jednostkowej
                    return "- /-";
                }

                return `${wynik.toFixed(2)} /${jednostkaWynikowa}`;
            };
            
            // ZMODYFIKOWANE: Logika listy (Filtrowanie i Sortowanie - Zadanie 4)
            const wyswietlListe = () => {
                listaProduktowDiv.innerHTML = '';
                
                // Pobierz aktualne dane z formularza do sortowania/filtrowania
                const aktualnyEAN = eanInput.value.trim();
                const aktualnaNazwa = nazwaInput.value.trim().toUpperCase();
                const aktualnePogrupowanie = document.getElementById('pogrupowanie').value;

                // Aktualizacja wyglƒÖdu przycisku filtra
                const ikonaFiltra = btnFiltr.querySelector('i');
                switch (stanFiltru) {
                    case 'ean':
                        btnFiltr.title = 'Filtruj listƒô: Tylko ten EAN';
                        ikonaFiltra.className = 'fas fa-barcode';
                        btnFiltr.style.backgroundColor = 'darkorange';
                        break;
                    case 'nazwa':
                        btnFiltr.title = 'Filtruj listƒô: Tylko ta Nazwa';
                        ikonaFiltra.className = 'fas fa-font';
                        btnFiltr.style.backgroundColor = 'darkorange';
                        break;
                    case 'grupa':
                        btnFiltr.title = 'Filtruj listƒô: Tylko ta Grupa';
                        ikonaFiltra.className = 'fas fa-layer-group';
                        btnFiltr.style.backgroundColor = 'darkorange';
                        break;
                    default: // 'wszystko'
                        btnFiltr.title = 'Filtruj listƒô: Wszystko';
                        ikonaFiltra.className = 'fas fa-filter';
                        btnFiltr.style.backgroundColor = 'var(--kolor-zapisz)';
                }


                if (bazaProduktow.length === 0) {
                    listaProduktowDiv.innerHTML = '<p style="text-align: center; color: #777;">Brak produkt√≥w w bazie. Dodaj pierwszy.</p>';
                    return;
                }
                
                // Krok 1: Filtrowanie (Zadanie 4 - filtr)
                const produktyDoWyswietlenia = bazaProduktow.filter(produkt => {
                    if (stanFiltru === 'wszystko') return true;
                    if (stanFiltru === 'ean' && aktualnyEAN) return produkt.ean === aktualnyEAN;
                    if (stanFiltru === 'nazwa' && aktualnaNazwa) return (produkt.nazwa || '').toUpperCase() === aktualnaNazwa;
                    if (stanFiltru === 'grupa' && aktualnePogrupowanie) return produkt.pogrupowanie === aktualnePogrupowanie;
                    return true; // Je≈õli filtr ustawiony, ale brak danych w formularzu, poka≈º wszystko
                });
                
                if (produktyDoWyswietlenia.length === 0) {
                    listaProduktowDiv.innerHTML = '<p style="text-align: center; color: #777;">Brak produkt√≥w pasujƒÖcych do filtra.</p>';
                    return;
                }

                // Krok 2: Sortowanie (Zadanie 4 - sortowanie)
                const posortowaneProdukty = produktyDoWyswietlenia.slice().sort((a, b) => {
                    const nazwaA = (a.nazwa || '').toUpperCase();
                    const nazwaB = (b.nazwa || '').toUpperCase();
                    const grupaA = a.pogrupowanie || '';
                    const grupaB = b.pogrupowanie || '';

                    // Funkcja oceny - wy≈ºszy wynik = wy≈ºej na li≈õcie
                    const getScore = (produkt) => {
                        if (aktualnyEAN && produkt.ean === aktualnyEAN) return 4; // Ten sam EAN
                        if (aktualnaNazwa && (produkt.nazwa || '').toUpperCase() === aktualnaNazwa) return 3; // Ta sama Nazwa
                        if (aktualnePogrupowanie && produkt.pogrupowanie === aktualnePogrupowanie) return 2; // Ta sama Grupa
                        return 0; // Reszta
                    };
                    
                    const scoreA = getScore(a);
                    const scoreB = getScore(b);

                    if (scoreA !== scoreB) {
                        return scoreB - scoreA; // Sortuj malejƒÖco wg oceny
                    }

                    // Sortowanie domy≈õlne (gdy oceny sƒÖ r√≥wne)
                    if (grupaA < grupaB) return -1;
                    if (grupaA > grupaB) return 1;

                    if (nazwaA < nazwaB) return -1;
                    if (nazwaA > nazwaB) return 1;
                    
                    return 0;
                });

                posortowaneProdukty.forEach(produkt => {
                    const karta = document.createElement('div');
                    karta.className = 'produkt-karta';
                    
                    // Pod≈õwietlenie na podstawie EAN LUB powiƒÖzanych EAN (jak w starej logice)
                    const isAktualnieWybrany = aktualnyEAN && (produkt.ean === aktualnyEAN || (produkt.powiazane && produkt.powiazane.split(',').map(e => e.trim()).includes(aktualnyEAN)));
                    if (isAktualnieWybrany) {
                         karta.style.border = '4px solid dodgerblue';
                    }

                    const cenaStandardowa = produkt.cena ? parseFloat(produkt.cena).toFixed(2) : '0.00';
                    const dataAktualizacji = produkt.dataAktualizacji || 'Brak daty';
                    const marka = produkt.marka || 'Brak marki';
                    const sklep = produkt.sklep || 'Brak sklepu';
                    
                    // ZMODYFIKOWANE: Obliczanie ceny jednostkowej (Zadanie 4)
                    const cenaPrzeliczeniowa = obliczCeneJednostkowaDlaKarty(produkt);
                    
                    const pogrupowanieTekst = produkt.pogrupowanie ? `[${produkt.pogrupowanie}]` : '';

                    let cenaPromoHTML = '';
                    if (produkt.cenaPromo && produkt.iloscZestaw) {
                        const cenaZaSzt = parseFloat(produkt.cenaPromo).toFixed(2);
                        const ilosc = parseInt(produkt.iloscZestaw) || 'N';
                        
                        cenaPromoHTML = `
                            <span class="cena-promo-kontener" title="Cena promocyjna w zestawie ${ilosc} sztuk">
                                ${cenaZaSzt} / ${ilosc} szt.
                            </span>
                        `;
                    }

                    karta.innerHTML = `
                        <div class="produkt-karta-naglowek">
                            <span class="produkt-nazwa">${produkt.nazwa || 'Brak nazwy'}</span>
                        </div>
                        <div class="produkt-metadata">
                            <span>${dataAktualizacji}</span>
                            <!-- ZMODYFIKOWANE: Wy≈õwietlanie ceny przeliczeniowej -->
                            <span> ${cenaPrzeliczeniowa} <span class="cena-reg-kontener"> ${cenaStandardowa} z≈Ç</span> </span>
                        </div>
                        <div class="produkt-detale">
                            <span>${marka} / ${sklep} </span>
                            <span>${cenaPromoHTML}</span>
                        </div>
                        <div class="produkt-metadata">
                            <span>${pogrupowanieTekst}</span>
                            <span>${produkt.ean}</span>
                        </div>
                    `;
                    
                    karta.addEventListener('click', () => {
                        wypelnijFormularz(produkt);
                        window.scrollTo(0, 0);
                    });
                    
                    listaProduktowDiv.appendChild(karta);
                });
            };

            const eksportujCSV = () => {
                if (bazaProduktow.length === 0) {
                    pokazKomunikat('Baza jest pusta. Brak danych do eksportu.', 'blad');
                    return;
                }
                
                const naglowki = KOLUMNY_CSV.join(',');
                const wiersze = bazaProduktow.map(produkt => {
                    return KOLUMNY_CSV.map(klucz => {
                        let wartosc = produkt[klucz] || '';
                        if (typeof wartosc === 'string' && (wartosc.includes(',') || wartosc.includes('"') || wartosc.includes('\n'))) {
                            wartosc = `"${wartosc.replace(/"/g, '""')}"`;
                        }
                        return wartosc;
                    }).join(',');
                }).join('\n');

                const finalnyCSV = `${naglowki}\n${wiersze}`;
                
                const blob = new Blob([finalnyCSV], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const data = new Date().toISOString().split('T')[0];
                a.setAttribute('href', url);
                a.setAttribute('download', `produkty_export_${data}.csv`);
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                pokazKomunikat('Pomy≈õlnie wyeksportowano do CSV.', 'sukces');
            };

            const polaczBaze = (importowaneProdukty) => {
                let dodaneCount = 0;
                let zaktualizowaneCount = 0;
                
                importowaneProdukty.forEach(importowany => {
                    // Logika ≈ÇƒÖczenia: EAN + Sklep jest unikalnym kluczem
                    const istniejacyIndeks = bazaProduktow.findIndex(p => p.ean === importowany.ean && p.sklep === importowany.sklep);
                    
                    if (istniejacyIndeks > -1) {
                        const istniejacy = bazaProduktow[istniejacyIndeks];
                        const dataIstniejaca = parseDate(istniejacy.dataAktualizacji);
                        const dataImportowana = parseDate(importowany.dataAktualizacji);
                        
                        // Aktualizuj tylko, je≈õli importowany ma nowszƒÖ datƒô
                        if (dataImportowana > dataIstniejaca) {
                            bazaProduktow[istniejacyIndeks] = importowany;
                            zaktualizowaneCount++;
                        } 
                    } else {
                        // Dodaj jako nowy, je≈õli nie ma pary EAN + Sklep
                        bazaProduktow.push(importowany);
                        dodaneCount++;
                    }
                });
                pokazKomunikat(`Scalanie zako≈Ñczone. Dodano: ${dodaneCount}, Zaktualizowano (nowsza data): ${zaktualizowaneCount}.`, 'sukces');
            };

            const obsluzImportPliku = (event) => {
                const plik = event.target.files[0];
                if (!plik) {
                    event.target.value = '';
                    return;
                }
                
                const trybLaczenia = window.confirm('Wybierz tryb importu:\n\nOK: Po≈ÇƒÖcz obecne dane z importowanymi (klucz: EAN + Sklep, zaktualizuj te z nowszƒÖ datƒÖ).\nAnuluj: Ca≈Çkowicie nadpisz obecnƒÖ bazƒô (UTRATA DANYCH).');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const tekstCSV = e.target.result;
                    try {
                        const importowaneProdukty = przetworzCSV(tekstCSV);
                        
                        if (trybLaczenia) {
                            polaczBaze(importowaneProdukty); 
                        } else {
                            if (!window.confirm('OSTATNIE OSTRZE≈ªENIE: Ca≈Çkowite nadpisanie (utrata) WSZYSTKICH obecnych danych w bazie. Kontynuowaƒá?')) {
                                event.target.value = '';
                                return;
                            }
                            bazaProduktow = importowaneProdukty;
                            pokazKomunikat(`Pomy≈õlnie zaimportowano ${importowaneProdukty.length} produkt√≥w (nadpisanie).`, 'sukces');
                        }
                        
                        zapiszBaze();
                        wyswietlListe();
                        wyczyscFormularz();

                    } catch (error) {
                        pokazKomunikat(`B≈ÇƒÖd importu: ${error.message}`, 'blad');
                        console.error("B≈ÇƒÖd przetwarzania CSV:", error);
                    }
                };
                reader.readAsText(plik);
                event.target.value = '';
            };


            const przetworzCSV = (csv) => {
                const linie = csv.split('\n').filter(line => line.trim() !== '');
                if (linie.length === 0) {
                    throw new Error('Plik CSV jest pusty.');
                }
                
                // U≈ºyj zdefiniowanych nag≈Ç√≥wk√≥w, a nie tych z pliku
                const naglowkiDoUzycia = KOLUMNY_CSV; 
                
                // Sprawd≈∫ nag≈Ç√≥wki z pliku (dla pewno≈õci)
                 const naglowkiPliku = linie[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                
                // Proste sprawdzenie, czy pierwszy nag≈Ç√≥wek to 'ean'. Je≈õli nie, mo≈ºe to byƒá z≈Çy format.
                 if (naglowkiPliku[0].toLowerCase() !== 'ean') {
                     console.warn("Nag≈Ç√≥wek pliku CSV nie zaczyna siƒô od 'ean'. Importowanie mo≈ºe siƒô nie udaƒá.");
                 }

                const nowaBaza = [];

                for (let i = 1; i < linie.length; i++) {
                    const wartosci = linie[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                    
                    // Je≈õli wiersz ma mniej kolumn ni≈º oczekiwano, pomi≈Ñ
                    if (wartosci.length < naglowkiDoUzycia.length) continue; 
                    
                    const produkt = {};
                    for (let j = 0; j < naglowkiDoUzycia.length; j++) {
                        // Przypisz warto≈õƒá do klucza z naglowkiDoUzycia
                        if(j < wartosci.length) {
                           produkt[naglowkiDoUzycia[j]] = wartosci[j];
                        } else {
                           produkt[naglowkiDoUzycia[j]] = ''; // Wype≈Çnij puste, je≈õli wiersz by≈Ç kr√≥tszy
                        }
                    }
                    
                    if (produkt.ean && produkt.nazwa) { 
                        nowaBaza.push(produkt);
                    } else {
                        console.warn(`Pominiƒôto wiersz (brak EAN lub Nazwy): ${linie[i]}`);
                    }
                }
                
                if (nowaBaza.length === 0) {
                    throw new Error('Nie znaleziono poprawnych produkt√≥w do zaimportowania.');
                }
                
                return nowaBaza;
            };


            // --- FUNKCJE SKANERA ---
            const startSkaner = (typ = 'glowny') => {
                skanerAktywny = typ; 
                skanerKontener.classList.add('aktywny');
                wynikSkanowaniaDiv.textContent = '≈Åadowanie kamery...';
                
                ostatnioZeskanowanyEAN = null;
                licznikPoprawnychOdczytow = 0;

                const inputStreamConfig = {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'), 
                    constraints: {
                        facingMode: "environment", 
                        width: { min: 1280 }, 
                        height: { min: 720 },
                    },
                    area: { top: "40%", right: "10%", left: "10%", bottom: "40%" } 
                };

                Quagga.init({
                    inputStream: inputStreamConfig,
                    locator: {
                        patchSize: "large", 
                        halfSample: true,
                        locate: true,
                    },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"],
                        multiple: false 
                    },
                    frequency: 10, 
                    numOfWorkers: 0, 
                }, function (err) {
                    if (err) {
                        wynikSkanowaniaDiv.textContent = 'B≈ÇƒÖd dostƒôpu do kamery: ' + err.name + '. Upewnij siƒô, ≈ºe u≈ºywasz HTTPS!';
                        console.error("B≈ÇƒÖd Quagga.init:", err);
                        return;
                    }
                    Quagga.start();
                    wynikSkanowaniaDiv.textContent = 'Ustaw kod EAN na ≈õrodku.';
                });

                Quagga.onDetected(onDetected);
                Quagga.onProcessed(onProcessed);
            };

            const stopSkaner = () => {
                if (Quagga && Quagga.stop) {
                    Quagga.stop();
                    Quagga.offProcessed();
                    Quagga.offDetected();
                }
                skanerKontener.classList.remove('aktywny');
                wynikSkanowaniaDiv.textContent = 'Gotowy do skanowania...';
            };

            const onProcessed = (result) => {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;
                
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

                if (result && result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "yellow", lineWidth: 2});
                }
            };

            const onDetected = (result) => {
                const ean = result.codeResult.code;
                
                if (!ean || !(ean.length === 13 || ean.length === 8 || ean.length === 12)) {
                    return; 
                }
                
                if (ean === ostatnioZeskanowanyEAN) {
                    licznikPoprawnychOdczytow++;
                    wynikSkanowaniaDiv.textContent = `Wykryto: ${ean} (Stabilizacja: ${licznikPoprawnychOdczytow}/${WYMAGANY_COUNT})`;
                } else {
                    ostatnioZeskanowanyEAN = ean;
                    licznikPoprawnychOdczytow = 1;
                    wynikSkanowaniaDiv.textContent = `Wykryto: ${ean} (Stabilizacja: 1/${WYMAGANY_COUNT})`;
                }

                if (licznikPoprawnychOdczytow >= WYMAGANY_COUNT) {
                    stopSkaner(); 
                    
                    if (skanerAktywny === 'glowny') {
                        eanInput.value = ean; 
                        wyszukajLubWyczysc(); 
                        pokazKomunikat(`Kod EAN zeskanowany: ${ean}. Gotowy do zapisu!`, 'sukces');
                    } else if (skanerAktywny === 'powiazany') {
                        const powiazaneInput = document.getElementById('powiazane');
                        const obecneEANy = powiazaneInput.value.trim();
                        
                        if (obecneEANy === '') {
                            powiazaneInput.value = ean;
                        } else {
                            const eanyArray = obecneEANy.split(',').map(e => e.trim());
                            if (!eanyArray.includes(ean)) {
                                powiazaneInput.value = obecneEANy + `, ${ean}`;
                            }
                        }
                        pokazKomunikat(`Dodano powiƒÖzany EAN: ${ean}`, 'sukces');
                    }
                    
                    window.scrollTo(0, 0);
                }
            };
            
            // --- ZMODYFIKOWANA FUNKCJA: AUTOUZUPE≈ÅNIANIE GRAMATURY I PRZELICZANIE CENY ---
            const autoUzupelnijGramature = () => {
                const nazwa = nazwaInput.value;
                
                // Te pola sƒÖ teraz input type="hidden"
                const gramaturaInput = document.getElementById('gramatura');
                const rodzajGramaturyInput = document.getElementById('rodzajGramatury');

                const regexGram = /(\d+[\.,]?\d*)\s*(g|ml|kg|l|m)\.?\s*$/i; 
                const regexSzt = /(\d+)\s*(szt)\.?\s*$/i;
                
                const matchGram = nazwa.match(regexGram);
                const matchSzt = nazwa.match(regexSzt);
                
                let znalezionaGramatura = null;
                let znalezionaJednostka = null;

                if (matchGram) {
                    znalezionaGramatura = matchGram[1].replace(',', '.'); 
                    znalezionaJednostka = matchGram[2].toLowerCase();
                } else if (matchSzt) {
                    znalezionaGramatura = matchSzt[1];
                    znalezionaJednostka = 'szt';
                } else {
                    znalezionaGramatura = 1;
                    znalezionaJednostka = 'szt';
                }

                // Ustaw warto≈õci w ukrytych inputach
                gramaturaInput.value = znalezionaGramatura;
                rodzajGramaturyInput.value = znalezionaJednostka;

                // Zaktualizuj widok tekstowy
                zaktualizujWidokGramatury(znalezionaGramatura, znalezionaJednostka);
                
                // Przelicz cenƒô jednostkowƒÖ (bo zmieni≈Ça siƒô gramatura)
                obliczCeneJednostkowa();
            };

            // --- NOWA FUNKCJA: OBLICZANIE CENY JEDNOSTKOWEJ ---
            const obliczCeneJednostkowa = () => {
                const cena = parseFloat(cenaInput.value);
                const waga = parseFloat(gramaturaInput.value);
                const jednostka = rodzajGramaturyInput.value;

                if (!cena || isNaN(cena) || !waga || isNaN(waga) || !jednostka || waga === 0) {
                    cenaJednostkowaDisplay.textContent = "- /-";
                    return;
                }

                let wynik = 0;
                let jednostkaWynikowa = "";

                // Logika przeliczania
                if (jednostka === 'g' || jednostka === 'ml') {
                    wynik = (cena / waga) * 100;
                    jednostkaWynikowa = (jednostka === 'g') ? '100g' : '100ml';
                } else if (jednostka === 'kg' || jednostka === 'l' || jednostka === 'm') {
                     wynik = cena / waga;
                     jednostkaWynikowa = jednostka;
                } else if (jednostka === 'szt' && waga > 1) {
                     wynik = cena / waga;
                     jednostkaWynikowa = 'szt';
                } else {
                    // Domy≈õlnie (dla 1 szt) nie pokazuj
                    cenaJednostkowaDisplay.textContent = "- /-";
                    return;
                }

                cenaJednostkowaDisplay.textContent = `${wynik.toFixed(2)} /${jednostkaWynikowa}`;
            };


            // --- INICJALIZACJA I OBS≈ÅUGA ZDARZE≈É ---
            
            // ZMODYFIKOWANE: Przypisanie nowych/zmienionych funkcji do przycisk√≥w
            btnDodaj.addEventListener('click', dodajProdukt); 
            btnZapiszWspolne.addEventListener('click', zapiszDaneWspolne); 
            
            btnUsun.addEventListener('click', usunProdukt);
            btnEksport.addEventListener('click', eksportujCSV);
            btnImport.addEventListener('click', () => inputImport.click()); 
            inputImport.addEventListener('change', obsluzImportPliku); 
            btnWyczyscBaze.addEventListener('click', wyczyscCalaBaze);
            
            // ZMODYFIKOWANE: Logika przycisku filtra (Zadanie 4)
            btnFiltr.addEventListener('click', () => {
                if (stanFiltru === 'wszystko') {
                    stanFiltru = 'ean';
                } else if (stanFiltru === 'ean') {
                    stanFiltru = 'nazwa';
                } else if (stanFiltru === 'nazwa') {
                    stanFiltru = 'grupa';
                } else if (stanFiltru === 'grupa') {
                    stanFiltru = 'wszystko';
                }
                wyswietlListe(); // Od≈õwie≈º listƒô po zmianie filtra
            });

            // ZMODYFIKOWANE: Przycisk skanowania u≈ºywa teraz `zapiszISkanujNowy`
            btnSkanujZapisz.addEventListener('click', zapiszISkanujNowy);
            
            btnSkanujPowiazany.addEventListener('click', () => startSkaner('powiazany')); 
            btnZamknijSkaner.addEventListener('click', stopSkaner);
            
            nazwaInput.addEventListener('input', autoUzupelnijGramature);
            
            // Dodatkowy nas≈Çuch zmian ceny, aby przeliczaƒá jednostkowƒÖ
            cenaInput.addEventListener('input', obliczCeneJednostkowa);

            eanInput.addEventListener('blur', wyszukajLubWyczysc);

            const zaznaczPrzyKliknieciu = (event) => event.target.select();
            cenaInput.addEventListener('click', zaznaczPrzyKliknieciu);
            cenaPromoInput.addEventListener('click', zaznaczPrzyKliknieciu);

            // Start
            zaladujBaze();
            wyczyscFormularz(); 
            eanInput.focus();
        });
    </script>
</body>
</html>
